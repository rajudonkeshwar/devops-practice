pipeline {
    agent {
    docker {
      image 'abhishekf5/maven-abhishek-docker-agent:v1'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock' // mount Docker socket to access the host's Docker daemon
    }
    }

    stages {
    stage('Checkout Code') {
        steps {
            echo 'scm git'
            git branch: 'main', url: 'https://github.com/rajudonkeshwar/devops-practice.git'
        }
    }
    
    
    stage('Build and Test') {
      steps {
        sh 'ls -ltr'
        // build the project and create a JAR file
        sh 'cd java-cicd-project/spring-boot-app && mvn clean package'
      }
    }


    stage('sonar') {
    steps {
        echo 'scanning project'
        sh 'ls -ltr'
        sh '''cd java-cicd-project/spring-boot-app && mvn sonar:sonar \\
              -Dsonar.host.url=http://localhost:9000 \\
              -Dsonar.login=squ_d519f9f045bdd07c9fb4866a7614f18155c09308'''
    }
}




    stage('Build docker image'){
    steps{
        script{
            echo 'docker image build'
  sh 'cd java-cicd-project/spring-boot-app && docker build -t rajudonkeshwar/java:${BUILD_NUMBER} .'
        }
    }
}
		
    stage('docker image scan'){
    steps{
        sh "trivy image rajudonkeshwar/java:${BUILD_NUMBER}"
    }
}		


stage('Push image to Hub'){
    steps{
        script{
            withCredentials([string(credentialsId: 'dockerhub', variable: 'dockerhub')]) {
            sh 'sudo docker login -u rajudonkeshwar -p ${dockerhub}'

      }
            sh 'sudo docker push rajudonkeshwar/java:${BUILD_NUMBER}'
        }
    }
}

  }
}
